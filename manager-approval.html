<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager Approval - Expense Claim</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 700px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); overflow: hidden; }
        .header { padding: 25px; text-align: center; color: white; }
        .header.adjust { background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); }
        .header.reject { background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%); }
        .header h1 { font-size: 22px; font-weight: 700; margin-bottom: 5px; }
        .header p { font-size: 14px; opacity: 0.9; }
        .form-container { padding: 30px; }
        .approver-info { background: linear-gradient(135deg, #EBF5FF 0%, #DBEAFE 100%); border-radius: 8px; padding: 12px 15px; margin-bottom: 20px; border-left: 4px solid #3B82F6; display: flex; align-items: center; gap: 10px; }
        .approver-info .icon { font-size: 20px; }
        .approver-info .text { font-size: 14px; color: #1E40AF; }
        .approver-info .email { font-weight: 600; }
        .claim-summary { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 10px; padding: 20px; margin-bottom: 25px; border-left: 4px solid #3498db; }
        .claim-summary h3 { color: #2c3e50; margin-bottom: 15px; font-size: 16px; }
        .summary-grid { display: grid; grid-template-columns: 130px 1fr; gap: 8px 15px; }
        .summary-label { color: #666; font-size: 14px; }
        .summary-value { color: #333; font-weight: 500; font-size: 14px; }
        .summary-value.highlight { color: #e74c3c; font-size: 24px; font-weight: 700; }
        .amount-display { text-align: center; margin-top: 15px; padding-top: 15px; border-top: 1px dashed #ccc; }
        .amount-display .label { font-size: 12px; color: #666; margin-top: 5px; }
        .form-section { background: #f8f9fa; border-radius: 10px; padding: 25px; margin-bottom: 20px; }
        .form-section h3 { color: #333; margin-bottom: 20px; padding-bottom: 10px; font-size: 16px; }
        .form-section.adjust h3 { border-bottom: 2px solid #F59E0B; }
        .form-section.reject h3 { border-bottom: 2px solid #EF4444; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; color: #555; margin-bottom: 8px; font-size: 14px; }
        .form-group label .required { color: #e74c3c; }
        .form-group input, .form-group textarea { width: 100%; padding: 14px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; transition: all 0.3s; }
        .form-group input:focus, .form-group textarea:focus { outline: none; border-color: #F59E0B; box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2); }
        .form-section.reject .form-group input:focus, .form-section.reject .form-group textarea:focus { border-color: #EF4444; box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2); }
        .form-group textarea { min-height: 120px; resize: vertical; }
        .amount-input-wrapper { position: relative; }
        .amount-input-wrapper .currency { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: #666; font-weight: 600; }
        .amount-input-wrapper input { padding-left: 60px; font-size: 18px; font-weight: 600; }
        .amount-comparison { display: flex; justify-content: space-around; align-items: center; background: white; padding: 15px; border-radius: 8px; margin-top: 15px; }
        .amount-box { text-align: center; }
        .amount-box .label { font-size: 12px; color: #666; margin-bottom: 5px; }
        .amount-box .value { font-size: 20px; font-weight: 700; }
        .amount-box .value.original { color: #666; text-decoration: line-through; }
        .amount-box .value.new { color: #10B981; }
        .amount-arrow { font-size: 24px; color: #ccc; }
        .info-box { background: #FEF3C7; border-left: 4px solid #F59E0B; padding: 15px; border-radius: 0 8px 8px 0; margin-bottom: 20px; }
        .info-box.reject { background: #FEE2E2; border-left-color: #EF4444; }
        .info-box p { color: #92400E; font-size: 14px; margin: 0; }
        .info-box.reject p { color: #991B1B; }
        .button-section { display: flex; gap: 15px; margin-top: 25px; }
        .btn { flex: 1; padding: 16px 24px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-cancel { background: #E5E7EB; color: #4B5563; }
        .btn-cancel:hover { background: #D1D5DB; }
        .btn-submit.adjust { background-color: #B45309; color: white; }
        .btn-submit.adjust:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(180, 83, 9, 0.4); }
        .btn-submit.reject { background-color: #DC2626; color: white; }
        .btn-submit.reject:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(220, 38, 38, 0.4); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; z-index: 1000; }
        .loading-overlay.show { display: flex; }
        .loading-content { background: white; padding: 40px; border-radius: 12px; text-align: center; }
        .spinner { width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid #F59E0B; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        .spinner.reject { border-top-color: #EF4444; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .result-page { display: none; text-align: center; padding: 50px 30px; }
        .result-page.show { display: block; }
        .result-icon { width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 40px; background: linear-gradient(135deg, #10B981 0%, #059669 100%); color: white; }
        .result-page h2 { margin-bottom: 10px; }
        .result-page p { color: #666; margin-bottom: 20px; }
        .result-details { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 25px; text-align: left; }
        .result-details p { margin: 8px 0; color: #333; }
        .btn-close { padding: 12px 30px; background: #6B7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
        @media (max-width: 600px) { .summary-grid { grid-template-columns: 1fr; } .button-section { flex-direction: column; } .amount-comparison { flex-direction: column; gap: 10px; } .amount-arrow { transform: rotate(90deg); } }
    </style>
</head>
<body>
    <div class="container">
        <div id="formView">
            <div class="header" id="header">
                <h1 id="headerTitle">Adjust Claim Amount</h1>
                <p id="headerSubtitle">Review and modify the claim amount</p>
            </div>
            <div class="form-container">
                <div class="approver-info">
                    <span class="icon">ðŸ‘¤</span>
                    <span class="text">Approving as: <span class="email" id="approverEmailDisplay">-</span></span>
                </div>
                <div class="claim-summary">
                    <h3>Claim Summary</h3>
                    <div class="summary-grid">
                        <span class="summary-label">Claim ID:</span>
                        <span class="summary-value" id="displayClaimId">-</span>
                        <span class="summary-label">Staff Name:</span>
                        <span class="summary-value" id="displayStaffName">-</span>
                        <span class="summary-label">Department:</span>
                        <span class="summary-value" id="displayDepartment">-</span>
                        <span class="summary-label">Month(s):</span>
                        <span class="summary-value" id="displayMonths">-</span>
                    </div>
                    <div class="amount-display">
                        <span class="summary-value highlight" id="displayAmount">SGD $0.00</span>
                        <p class="label">ORIGINAL CLAIM AMOUNT</p>
                    </div>
                </div>
                <form id="approvalForm">
                    <div class="form-section adjust" id="adjustSection">
                        <h3>Adjust Amount</h3>
                        <div class="info-box"><p><strong>Note:</strong> Enter the approved amount below. The staff will be notified of any adjustments.</p></div>
                        <div class="form-group">
                            <label>Approved Amount <span class="required">*</span></label>
                            <div class="amount-input-wrapper">
                                <span class="currency">SGD $</span>
                                <input type="number" id="adjustedAmount" step="0.01" min="0" placeholder="0.00" required>
                            </div>
                        </div>
                        <div class="amount-comparison" id="amountComparison" style="display: none;">
                            <div class="amount-box"><p class="label">Original</p><p class="value original" id="compareOriginal">$0.00</p></div>
                            <span class="amount-arrow">â†’</span>
                            <div class="amount-box"><p class="label">Approved</p><p class="value new" id="compareNew">$0.00</p></div>
                        </div>
                        <div class="form-group">
                            <label>Reason for Adjustment (Optional)</label>
                            <textarea id="adjustReason" placeholder="e.g., Receipts for items 2 and 3 are missing..."></textarea>
                        </div>
                    </div>
                    <div class="form-section reject" id="rejectSection" style="display: none;">
                        <h3>Reject Claim</h3>
                        <div class="info-box reject"><p><strong>Warning:</strong> This will reject the entire claim. The staff will be notified with your reason.</p></div>
                        <div class="form-group">
                            <label>Reason for Rejection <span class="required">*</span></label>
                            <textarea id="rejectReason" placeholder="Please provide a clear reason for rejection..."></textarea>
                        </div>
                    </div>
                    <div class="button-section">
                        <button type="button" class="btn btn-cancel" id="backBtn">Back</button>
                        <button type="submit" class="btn btn-submit" id="submitBtn"><span id="submitBtnText">Submit Adjustment</span></button>
                    </div>
                </form>
            </div>
        </div>
        <div id="resultView" class="result-page">
            <div class="result-icon" id="resultIcon">âœ“</div>
            <h2 id="resultTitle">Success!</h2>
            <p id="resultMessage">The claim has been processed.</p>
            <div class="result-details">
                <p><strong>Claim ID:</strong> <span id="resultClaimId">-</span></p>
                <p><strong>Decision:</strong> <span id="resultDecision">-</span></p>
                <p><strong>Amount:</strong> <span id="resultAmount">-</span></p>
                <p><strong>Approved By:</strong> <span id="resultApprover">-</span></p>
            </div>
            <p style="font-size: 13px; color: #999;">Notifications have been sent.</p>
            <button class="btn-close" id="closeBtn">Close Window</button>
        </div>
    </div>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner" id="loadingSpinner"></div>
            <p id="loadingText">Processing...</p>
        </div>
    </div>

    <script type="text/javascript">
        var WEBHOOK_URL = 'https://ctlee0712.app.n8n.cloud/webhook/manager-decision';
        
        var urlParams = new URLSearchParams(window.location.search);
        var claimId = urlParams.get('claimId') || '';
        var staffName = urlParams.get('staffName') || '';
        var staffEmail = urlParams.get('staffEmail') || '';
        var department = urlParams.get('department') || '';
        var months = urlParams.get('months') || '';
        var amount = urlParams.get('amount') || '0';
        var action = urlParams.get('action') || 'adjust';
        var approverEmail = urlParams.get('approverEmail') || '';

        function init() {
            document.getElementById('approverEmailDisplay').textContent = decodeURIComponent(approverEmail) || 'Unknown';
            document.getElementById('displayClaimId').textContent = decodeURIComponent(claimId);
            document.getElementById('displayStaffName').textContent = decodeURIComponent(staffName);
            document.getElementById('displayDepartment').textContent = decodeURIComponent(department) || '-';
            document.getElementById('displayMonths').textContent = decodeURIComponent(months) || '-';
            document.getElementById('displayAmount').textContent = 'SGD $' + parseFloat(amount).toFixed(2);
            document.getElementById('compareOriginal').textContent = '$' + parseFloat(amount).toFixed(2);
            document.getElementById('adjustedAmount').value = amount;
            
            if (action === 'reject') {
                setupRejectMode();
            } else {
                setupAdjustMode();
            }
            
            document.getElementById('approvalForm').addEventListener('submit', handleSubmit);
            document.getElementById('adjustedAmount').addEventListener('input', updateAmountComparison);
            document.getElementById('backBtn').addEventListener('click', function() { window.history.back(); });
            document.getElementById('closeBtn').addEventListener('click', function() { window.close(); });
        }

        function setupAdjustMode() {
            document.getElementById('header').className = 'header adjust';
            document.getElementById('headerTitle').textContent = 'Adjust Claim Amount';
            document.getElementById('headerSubtitle').textContent = 'Review and modify the claim amount';
            document.getElementById('adjustSection').style.display = 'block';
            document.getElementById('rejectSection').style.display = 'none';
            document.getElementById('submitBtn').className = 'btn btn-submit adjust';
            document.getElementById('submitBtnText').textContent = 'Submit Adjustment';
            document.getElementById('loadingSpinner').className = 'spinner';
        }

        function setupRejectMode() {
            document.getElementById('header').className = 'header reject';
            document.getElementById('headerTitle').textContent = 'Reject Claim';
            document.getElementById('headerSubtitle').textContent = 'Please provide a reason for rejection';
            document.getElementById('adjustSection').style.display = 'none';
            document.getElementById('rejectSection').style.display = 'block';
            document.getElementById('submitBtn').className = 'btn btn-submit reject';
            document.getElementById('submitBtnText').textContent = 'Confirm Rejection';
            document.getElementById('loadingSpinner').className = 'spinner reject';
        }

        function updateAmountComparison() {
            var newAmount = parseFloat(document.getElementById('adjustedAmount').value) || 0;
            document.getElementById('compareNew').textContent = '$' + newAmount.toFixed(2);
            if (newAmount !== parseFloat(amount) && newAmount > 0) {
                document.getElementById('amountComparison').style.display = 'flex';
            } else {
                document.getElementById('amountComparison').style.display = 'none';
            }
        }

        function handleSubmit(e) {
            e.preventDefault();
            
            var isReject = action === 'reject';
            
            if (isReject) {
                var rejectReason = document.getElementById('rejectReason').value.trim();
                if (!rejectReason) {
                    alert('Please provide a reason for rejection.');
                    return false;
                }
            } else {
                var amt = parseFloat(document.getElementById('adjustedAmount').value);
                if (isNaN(amt) || amt < 0) {
                    alert('Please enter a valid amount.');
                    return false;
                }
            }
            
            document.getElementById('loadingOverlay').classList.add('show');
            document.getElementById('loadingText').textContent = isReject ? 'Rejecting claim...' : 'Submitting adjustment...';
            
            var payload = {
                claimId: decodeURIComponent(claimId),
                staffName: decodeURIComponent(staffName),
                staffEmail: decodeURIComponent(staffEmail),
                originalAmount: parseFloat(amount),
                action: isReject ? 'Rejected' : 'Adjusted',
                adjustedAmount: isReject ? 0 : parseFloat(document.getElementById('adjustedAmount').value),
                reason: isReject ? document.getElementById('rejectReason').value.trim() : document.getElementById('adjustReason').value.trim(),
                managerDate: new Date().toISOString(),
                approverEmail: decodeURIComponent(approverEmail)
            };
            
            fetch(WEBHOOK_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(function(response) { return response.json(); })
            .then(function(result) {
                document.getElementById('loadingOverlay').classList.remove('show');
                if (result.success) {
                    showResult(payload);
                } else {
                    alert('Error: ' + (result.message || 'Processing failed'));
                }
            })
            .catch(function(error) {
                document.getElementById('loadingOverlay').classList.remove('show');
                alert('Error: ' + error.message);
            });
            
            return false;
        }

        function showResult(data) {
            document.getElementById('formView').style.display = 'none';
            document.getElementById('resultView').classList.add('show');
            
            var isReject = data.action === 'Rejected';
            
            document.getElementById('resultTitle').style.color = isReject ? '#EF4444' : '#10B981';
            document.getElementById('resultTitle').textContent = isReject ? 'Claim Rejected' : 'Amount Adjusted';
            document.getElementById('resultMessage').textContent = isReject ? 'The claim has been rejected.' : 'The amount has been adjusted.';
            document.getElementById('resultClaimId').textContent = data.claimId;
            document.getElementById('resultDecision').textContent = data.action;
            document.getElementById('resultDecision').style.color = isReject ? '#EF4444' : '#F59E0B';
            document.getElementById('resultAmount').textContent = isReject ? 'N/A' : 'SGD $' + data.adjustedAmount.toFixed(2);
            document.getElementById('resultApprover').textContent = data.approverEmail;
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
