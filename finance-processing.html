<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Processing - Expense Claim</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 700px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); overflow: hidden; }
        .header { padding: 25px; text-align: center; color: white; }
        .header.process { background: linear-gradient(135deg, #10B981 0%, #059669 100%); }
        .header.adjust { background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); }
        .header.reject { background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%); }
        .header h1 { font-size: 22px; font-weight: 700; margin-bottom: 5px; }
        .header p { font-size: 14px; opacity: 0.9; }
        .form-container { padding: 30px; }
        .approver-info { background: linear-gradient(135deg, #EBF5FF 0%, #DBEAFE 100%); border-radius: 8px; padding: 12px 15px; margin-bottom: 20px; border-left: 4px solid #3B82F6; display: flex; align-items: center; gap: 10px; }
        .approver-info .icon { font-size: 20px; }
        .approver-info .text { font-size: 14px; color: #1E40AF; }
        .approver-info .email { font-weight: 600; }
        .claim-summary { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 10px; padding: 20px; margin-bottom: 25px; border-left: 4px solid #10B981; }
        .claim-summary h3 { color: #2c3e50; margin-bottom: 15px; font-size: 16px; }
        .summary-grid { display: grid; grid-template-columns: 140px 1fr; gap: 8px 15px; }
        .summary-label { color: #666; font-size: 14px; }
        .summary-value { color: #333; font-weight: 500; font-size: 14px; }
        .summary-value.highlight { color: #10B981; font-size: 24px; font-weight: 700; }
        .amount-display { text-align: center; margin-top: 15px; padding-top: 15px; border-top: 1px dashed #ccc; }
        .amount-display .label { font-size: 12px; color: #666; margin-top: 5px; }
        .action-selection { margin-bottom: 25px; }
        .action-selection h3 { color: #333; margin-bottom: 15px; font-size: 16px; }
        .action-buttons { display: flex; gap: 10px; }
        .action-btn { flex: 1; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; background: white; cursor: pointer; transition: all 0.3s; text-align: center; }
        .action-btn:hover { border-color: #999; }
        .action-btn.selected.process { border-color: #10B981; background: #D1FAE5; }
        .action-btn.selected.adjust { border-color: #F59E0B; background: #FEF3C7; }
        .action-btn.selected.reject { border-color: #EF4444; background: #FEE2E2; }
        .action-btn .icon { font-size: 28px; margin-bottom: 8px; }
        .action-btn .title { font-weight: 600; font-size: 14px; color: #333; }
        .action-btn .subtitle { font-size: 12px; color: #666; margin-top: 4px; }
        .form-section { background: #f8f9fa; border-radius: 10px; padding: 25px; margin-bottom: 20px; display: none; }
        .form-section.active { display: block; }
        .form-section h3 { color: #333; margin-bottom: 20px; padding-bottom: 10px; font-size: 16px; }
        .form-section.process h3 { border-bottom: 2px solid #10B981; }
        .form-section.adjust h3 { border-bottom: 2px solid #F59E0B; }
        .form-section.reject h3 { border-bottom: 2px solid #EF4444; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; color: #555; margin-bottom: 8px; font-size: 14px; }
        .form-group label .required { color: #e74c3c; }
        .form-group input, .form-group textarea { width: 100%; padding: 14px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; transition: all 0.3s; }
        .form-group input:focus, .form-group textarea:focus { outline: none; border-color: #10B981; box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2); }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .amount-input-wrapper { position: relative; }
        .amount-input-wrapper .currency { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: #666; font-weight: 600; }
        .amount-input-wrapper input { padding-left: 60px; font-size: 18px; font-weight: 600; }
        .info-box { padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .info-box.process { background: #D1FAE5; border-left: 4px solid #10B981; }
        .info-box.adjust { background: #FEF3C7; border-left: 4px solid #F59E0B; }
        .info-box.reject { background: #FEE2E2; border-left: 4px solid #EF4444; }
        .info-box p { font-size: 14px; margin: 0; }
        .info-box.process p { color: #065F46; }
        .info-box.adjust p { color: #92400E; }
        .info-box.reject p { color: #991B1B; }
        .button-section { display: flex; gap: 15px; margin-top: 25px; }
        .btn { flex: 1; padding: 16px 24px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-cancel { background: #E5E7EB; color: #4B5563; }
        .btn-cancel:hover { background: #D1D5DB; }
        .btn-submit.process { background-color: #047857; color: white; }
        .btn-submit.adjust { background-color: #B45309; color: white; }
        .btn-submit.reject { background-color: #DC2626; color: white; }
        .btn-submit:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(0,0,0,0.2); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; z-index: 1000; }
        .loading-overlay.show { display: flex; }
        .loading-content { background: white; padding: 40px; border-radius: 12px; text-align: center; }
        .spinner { width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid #10B981; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .result-page { display: none; text-align: center; padding: 50px 30px; }
        .result-page.show { display: block; }
        .result-icon { width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 40px; background: linear-gradient(135deg, #10B981 0%, #059669 100%); color: white; }
        .result-page h2 { margin-bottom: 10px; }
        .result-page p { color: #666; margin-bottom: 20px; }
        .result-details { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 25px; text-align: left; }
        .result-details p { margin: 8px 0; color: #333; }
        .btn-close { padding: 12px 30px; background: #6B7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
        @media (max-width: 600px) { .summary-grid { grid-template-columns: 1fr; } .action-buttons { flex-direction: column; } .button-section { flex-direction: column; } }
    </style>
</head>
<body>
    <div class="container">
        <div id="formView">
            <div class="header process" id="header">
                <h1 id="headerTitle">üí∞ Finance Processing</h1>
                <p id="headerSubtitle">Process the approved expense claim</p>
            </div>
            <div class="form-container">
                <div class="approver-info">
                    <span class="icon">üë§</span>
                    <span class="text">Processing as: <span class="email" id="approverEmailDisplay">-</span></span>
                </div>
                <div class="claim-summary">
                    <h3>üìã Claim Details</h3>
                    <div class="summary-grid">
                        <span class="summary-label">Claim ID:</span>
                        <span class="summary-value" id="displayClaimId">-</span>
                        <span class="summary-label">Staff Name:</span>
                        <span class="summary-value" id="displayStaffName">-</span>
                        <span class="summary-label">Staff Email:</span>
                        <span class="summary-value" id="displayStaffEmail">-</span>
                        <span class="summary-label">Manager Status:</span>
                        <span class="summary-value" id="displayStatus" style="color: #10B981;">‚úÖ Approved</span>
                    </div>
                    <div class="amount-display">
                        <span class="summary-value highlight" id="displayAmount">SGD $0.00</span>
                        <p class="label">APPROVED AMOUNT</p>
                    </div>
                </div>
                <div class="action-selection">
                    <h3>Select Action:</h3>
                    <div class="action-buttons">
                        <div class="action-btn selected process" data-action="process" onclick="selectAction('process')">
                            <div class="icon">‚úÖ</div>
                            <div class="title">Mark as Processed</div>
                            <div class="subtitle">Confirm payment completed</div>
                        </div>
                        <div class="action-btn" data-action="adjust" onclick="selectAction('adjust')">
                            <div class="icon">üí∞</div>
                            <div class="title">Adjust Amount</div>
                            <div class="subtitle">Modify final amount</div>
                        </div>
                        <div class="action-btn" data-action="reject" onclick="selectAction('reject')">
                            <div class="icon">‚ùå</div>
                            <div class="title">Reject</div>
                            <div class="subtitle">Return to manager</div>
                        </div>
                    </div>
                </div>
                <form id="processingForm">
                    <div class="form-section process active" id="processSection">
                        <h3>‚úÖ Confirm Processing</h3>
                        <div class="info-box process"><p><strong>üìù Note:</strong> Confirming will mark this claim as processed.</p></div>
                        <div class="form-group">
                            <label>Payment Reference (Optional)</label>
                            <input type="text" id="paymentRef" placeholder="e.g., TRF-2025-001234">
                        </div>
                        <div class="form-group">
                            <label>Processing Notes (Optional)</label>
                            <textarea id="processNotes" placeholder="Any additional notes..."></textarea>
                        </div>
                    </div>
                    <div class="form-section adjust" id="adjustSection">
                        <h3>üí∞ Adjust Amount</h3>
                        <div class="info-box adjust"><p><strong>‚ö†Ô∏è Note:</strong> Enter the final reimbursement amount.</p></div>
                        <div class="form-group">
                            <label>Final Amount <span class="required">*</span></label>
                            <div class="amount-input-wrapper">
                                <span class="currency">SGD $</span>
                                <input type="number" id="adjustedAmount" step="0.01" min="0" placeholder="0.00">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Reason for Adjustment <span class="required">*</span></label>
                            <textarea id="adjustReason" placeholder="e.g., Partial receipts approved..."></textarea>
                        </div>
                    </div>
                    <div class="form-section reject" id="rejectSection">
                        <h3>‚ùå Reject & Return to Manager</h3>
                        <div class="info-box reject"><p><strong>‚ö†Ô∏è Warning:</strong> This will return the claim to the manager.</p></div>
                        <div class="form-group">
                            <label>Reason for Rejection <span class="required">*</span></label>
                            <textarea id="rejectReason" placeholder="e.g., Missing documentation..."></textarea>
                        </div>
                    </div>
                    <div class="button-section">
                        <button type="button" class="btn btn-cancel" onclick="window.close(); window.history.back();">‚Üê Back</button>
                        <button type="submit" class="btn btn-submit process" id="submitBtn"><span id="submitBtnText">‚úÖ Confirm Processing</span></button>
                    </div>
                </form>
            </div>
        </div>
        <div id="resultView" class="result-page">
            <div class="result-icon">‚úì</div>
            <h2 id="resultTitle">Processing Complete!</h2>
            <p id="resultMessage">The claim has been processed successfully.</p>
            <div class="result-details">
                <p><strong>Claim ID:</strong> <span id="resultClaimId">-</span></p>
                <p><strong>Action:</strong> <span id="resultAction">-</span></p>
                <p><strong>Amount:</strong> <span id="resultAmount">-</span></p>
                <p><strong>Processed By:</strong> <span id="resultApprover">-</span></p>
            </div>
            <p style="font-size: 13px; color: #999;">‚úâÔ∏è The staff has been notified.</p>
            <button class="btn-close" onclick="window.close();">Close Window</button>
        </div>
    </div>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p id="loadingText">Processing...</p>
        </div>
    </div>
    <script>
        const WEBHOOK_URL = 'https://ctlee0712.app.n8n.cloud/webhook/finance-decision';
        const urlParams = new URLSearchParams(window.location.search);
        const claimId = urlParams.get('claimId') || '';
        const staffName = urlParams.get('staffName') || '';
        const staffEmail = urlParams.get('staffEmail') || '';
        const amount = urlParams.get('amount') || '0';
        const status = urlParams.get('status') || 'Approved';
        const approverEmail = urlParams.get('approverEmail') || '';
        let currentAction = 'process';

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('approverEmailDisplay').textContent = decodeURIComponent(approverEmail) || 'Unknown';
            document.getElementById('displayClaimId').textContent = decodeURIComponent(claimId);
            document.getElementById('displayStaffName').textContent = decodeURIComponent(staffName);
            document.getElementById('displayStaffEmail').textContent = decodeURIComponent(staffEmail);
            document.getElementById('displayAmount').textContent = 'SGD $' + parseFloat(amount).toFixed(2);
            const statusEl = document.getElementById('displayStatus');
            if (status === 'Adjusted') { statusEl.textContent = 'üí∞ Adjusted'; statusEl.style.color = '#F59E0B'; }
            else { statusEl.textContent = '‚úÖ Approved'; statusEl.style.color = '#10B981'; }
            document.getElementById('adjustedAmount').value = amount;
        });

        function selectAction(action) {
            currentAction = action;
            document.querySelectorAll('.action-btn').forEach(btn => btn.classList.remove('selected', 'process', 'adjust', 'reject'));
            document.querySelector(`.action-btn[data-action="${action}"]`).classList.add('selected', action);
            document.querySelectorAll('.form-section').forEach(s => s.classList.remove('active'));
            document.getElementById(action + 'Section').classList.add('active');
            const header = document.getElementById('header');
            const headerTitle = document.getElementById('headerTitle');
            const headerSubtitle = document.getElementById('headerSubtitle');
            const submitBtn = document.getElementById('submitBtn');
            const submitBtnText = document.getElementById('submitBtnText');
            header.className = 'header ' + action;
            submitBtn.className = 'btn btn-submit ' + action;
            if (action === 'process') { headerTitle.textContent = 'üí∞ Finance Processing'; headerSubtitle.textContent = 'Process the approved expense claim'; submitBtnText.textContent = '‚úÖ Confirm Processing'; }
            else if (action === 'adjust') { headerTitle.textContent = 'üí∞ Adjust Amount'; headerSubtitle.textContent = 'Modify the final reimbursement amount'; submitBtnText.textContent = 'üí∞ Submit Adjustment'; }
            else { headerTitle.textContent = '‚ùå Reject Claim'; headerSubtitle.textContent = 'Return claim to manager for re-review'; submitBtnText.textContent = '‚ùå Confirm Rejection'; }
        }

        document.getElementById('processingForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (currentAction === 'adjust') {
                const adjAmount = parseFloat(document.getElementById('adjustedAmount').value);
                if (isNaN(adjAmount) || adjAmount < 0) { alert('Please enter a valid amount.'); return; }
                if (!document.getElementById('adjustReason').value.trim()) { alert('Please provide a reason.'); return; }
            } else if (currentAction === 'reject') {
                if (!document.getElementById('rejectReason').value.trim()) { alert('Please provide a reason.'); return; }
            }
            document.getElementById('loadingOverlay').classList.add('show');
            document.getElementById('loadingText').textContent = currentAction === 'process' ? 'Processing claim...' : currentAction === 'adjust' ? 'Submitting adjustment...' : 'Rejecting claim...';
            try {
                const payload = {
                    claimId: decodeURIComponent(claimId),
                    staffName: decodeURIComponent(staffName),
                    staffEmail: decodeURIComponent(staffEmail),
                    originalAmount: parseFloat(amount),
                    action: currentAction === 'process' ? 'Processed' : currentAction === 'adjust' ? 'Finance Adjusted' : 'Finance Rejected',
                    finalAmount: currentAction === 'adjust' ? parseFloat(document.getElementById('adjustedAmount').value) : parseFloat(amount),
                    paymentRef: document.getElementById('paymentRef').value.trim(),
                    notes: currentAction === 'process' ? document.getElementById('processNotes').value.trim() : currentAction === 'adjust' ? document.getElementById('adjustReason').value.trim() : document.getElementById('rejectReason').value.trim(),
                    financeDate: new Date().toISOString(),
                    approverEmail: decodeURIComponent(approverEmail)
                };
                const response = await fetch(WEBHOOK_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const result = await response.json();
                document.getElementById('loadingOverlay').classList.remove('show');
                if (result.success) { showResult(payload); } else { throw new Error(result.message || 'Failed'); }
            } catch (error) {
                document.getElementById('loadingOverlay').classList.remove('show');
                alert('Error: ' + error.message);
            }
        });

        function showResult(data) {
            document.getElementById('formView').style.display = 'none';
            document.getElementById('resultView').classList.add('show');
            const resultTitle = document.getElementById('resultTitle');
            const resultMessage = document.getElementById('resultMessage');
            if (data.action === 'Processed') { resultTitle.textContent = 'Payment Processed!'; resultTitle.style.color = '#10B981'; resultMessage.textContent = 'The claim has been marked as processed.'; }
            else if (data.action === 'Finance Adjusted') { resultTitle.textContent = 'Amount Adjusted!'; resultTitle.style.color = '#F59E0B'; resultMessage.textContent = 'The final amount has been adjusted.'; }
            else { resultTitle.textContent = 'Claim Rejected'; resultTitle.style.color = '#EF4444'; resultMessage.textContent = 'The claim has been returned to the manager.'; }
            document.getElementById('resultClaimId').textContent = data.claimId;
            document.getElementById('resultAction').textContent = data.action;
            document.getElementById('resultAction').style.color = data.action === 'Processed' ? '#10B981' : data.action === 'Finance Adjusted' ? '#F59E0B' : '#EF4444';
            document.getElementById('resultAmount').textContent = data.action === 'Finance Rejected' ? 'N/A' : 'SGD $' + data.finalAmount.toFixed(2);
            document.getElementById('resultApprover').textContent = data.approverEmail;
        }
    </script>
</body>
</html>
